---
title: "NOAA Storm Data Analysis"
author: "Tim Shores"
date: "July 25, 2015"
output: html_document
---
# Synopsis
Your data analysis must address the following questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

Consider writing your report as if it were to be read by a government or municipal manager who might be responsible for preparing for severe weather events and will need to prioritize resources for different types of events. However, there is no need to make any specific recommendations in your report.

- 10 sentences, no more.
- at least one figure containing a plot.
- no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.

# Data Processing

which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

First we load software libraries and display the processing software environment.

```{r software_env, echo = TRUE}
library(dplyr)
library(ggplot2)
options(scipen = 10)
sessionInfo()
```

Next we load the data.

```{r load_data, echo = TRUE, cache = TRUE}
datapath <- 
    paste("/home/tim/datasciencecoursera/Practicing-R/Reproducible Research/PeerAssessment2/repdata_data_StormData.csv.bz2")
storm0 <- read.csv(datapath)
```

After importing the data, we display details about the data frame, including the first few rows and columns. There are `r format(dim(storm0)[1], big.mark = ",")` rows and `r dim(storm0)[2]` columns in this dataset. The variable headers are already descriptive, so I don't modify them.

```{r display_data, echo = TRUE}
dim(storm0)
head(storm0[, 1:10])
```

Preprocessing for the first question, which seeks to rank storm events by harmfulness to health. The question is not limited by timeframe or location. We only need variables for types of events and health outcomes, which we interpret to mean INJURIES and FATALITIES. These will be added together as a new variable, Harm.total. We also check for missing values in the selected dataset, coded as NA (there are none).

```{r preprocess_question1, echo = TRUE}
storm1 <- 
    storm0 %>% 
    group_by(EVTYPE) %>% 
    select(EVTYPE, FATALITIES, INJURIES, REMARKS, REFNUM) %>%
    mutate(Harm.total = FATALITIES + INJURIES)

mean(is.na(storm1))
```

This Harm.total data grouped by storm event type is summarised to obtain sum, mean, and standard deviation. The top five harmful events by both sum and mean are extracted from the data, and are combined to create a unique set of most harmful storm events. We remove events with no standard deviation, as these indicate events that only happen once -- singular events should not attract the attention of managers.

```{r summarise_question1, echo = TRUE}
storm1.summary <- 
    storm1 %>% 
    summarise(Harm.sum = sum(Harm.total), 
              Harm.mean = round(mean(Harm.total), 5), 
              Harm.sd = sd(Harm.total)) %>% 
    filter(Harm.sum > 0)

# this creates three separate top five harmful sum, mean, and median, 
# then jams them together, removing duplicates.
top.harm.sum <- top_n(storm1.summary, 5, Harm.sum)
top.harm.mean <- top_n(storm1.summary, 5, Harm.mean)
storm1.top.harm <- unique(rbind(top.harm.sum, top.harm.mean))
storm1.top.harm <- filter(storm1.top.harm, !is.na(Harm.sd))

```

Preprocessing for the second question, which seeks to rank storm events by economic consquences. This question is also not limited by timeframe or location. We only need variables for types of events and economic outcomes, which is coded as 'damage' values representing dollar amounts for property and for crops. 

Both damage variables are accompanied by DMGEXP factor variables that define the value magnitude: K for thousands of dollars, M for millions, B for billions. I normalize this with the mutate() function in the first pipeline, which sets all damage values to thousands of dollars.

We also check for missing values in the selected dataset, coded as NA (there are none).

```{r preprocess_question2, echo = TRUE}
storm2 <- 
    storm0 %>% 
    group_by(EVTYPE) %>% 
    select(EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP, REMARKS, REFNUM) %>%
    mutate( 
       PROPDMG = ifelse(PROPDMGEXP == "K", 
                        PROPDMG, 
                        ifelse(PROPDMG == "M", 
                               PROPDMG * 1000, 
                               PROPDMG * 1000000)),
       CROPDMG = ifelse(CROPDMGEXP == "K",
                        CROPDMG,
                        ifelse(CROPDMG == "M",
                               CROPDMG * 1000,
                               CROPDMG * 1000000))
       ) %>%
    mutate(Dmg.total = PROPDMG + CROPDMG)

mean(is.na(storm2))
```

As with question 1 harm data, the economic damage data is summarised, producing a list of the top damaging event types that happen more than once.

```{r summarise_question2, echo = TRUE}
storm2.summary <- 
    storm2 %>%
    summarise(Dmg.sum = round(sum(Dmg.total), 2), 
              Dmg.mean = round(mean(Dmg.total), 2), 
              Dmg.sd = round(sd(Dmg.total), 2)) %>%
    filter(Dmg.sum > 0)

# this creates three separate top five damaging sum, mean, and median, 
# then jams them together, removing duplicates.
top.dmg.sum <- top_n(storm2.summary, 5, Dmg.sum)
top.dmg.mean <- top_n(storm2.summary, 5, Dmg.mean)
storm2.top.dmg <- unique(rbind(top.dmg.sum, top.dmg.mean))
storm2.top.dmg <- filter(storm2.top.dmg, !is.na(Dmg.sd))

```

# Results
Across the United States, the following events are most harmful with respect to population health:

```{r harm_event_factors, echo = TRUE}
storm1.top.harm[1]
```

This barplot compares the log of their sums, with color fill comparing the log of their means.

```{r plot1_harm, echo = TRUE}
harm.p <- ggplot(data = storm1.top.harm, aes(x = EVTYPE, y = log2(Harm.sum), fill = log2(Harm.mean)))
harm.p + geom_bar(stat = "identity") +
    xlab("Storm Event Type") + 
    ylab("log of Sum of Harmful Outcomes") + 
    scale_fill_continuous(name = "log of Mean of Harmful Outcomes") +
    geom_errorbar(aes(ymin = log2(Harm.sum)-log2(Harm.sd), ymax = log2(Harm.sum)+log2(Harm.sd)), 
                  width=.2, position=position_dodge(.9))
  
```

Across the United States, the following events have the greatest economic consequences:
```{r damage_event_factors, echo = TRUE}
storm2.top.dmg[1]
```

This barplot compares the log of their sums, with color fill comparing the log of their means.

```{r plot2_damage, echo = TRUE}
dmg.p <- ggplot(data = storm2.top.dmg, aes(x = EVTYPE, y = log2(Dmg.sum), fill = log2(Dmg.mean)))
dmg.p + geom_bar(stat = "identity") +
    xlab("Storm Event Type") + 
    ylab("log of Sum of Harmful Outcomes") + 
    scale_fill_continuous(name = "log of Mean of Harmful Outcomes") +
    geom_errorbar(aes(ymin = log2(Dmg.sum)-log2(Dmg.sd), ymax = log2(Dmg.sum)+log2(Dmg.sd)), 
                  width=.2, position=position_dodge(.9))
```


