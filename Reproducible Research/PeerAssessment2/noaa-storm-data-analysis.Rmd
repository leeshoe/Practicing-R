---
title: "NOAA Storm Data Analysis"
author: "Tim Shores"
date: "July 25, 2015"
output: html_document
---
# Synopsis
Your data analysis must address the following questions:

1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?
2. Across the United States, which types of events have the greatest economic consequences?

Consider writing your report as if it were to be read by a government or municipal manager who might be responsible for preparing for severe weather events and will need to prioritize resources for different types of events. However, there is no need to make any specific recommendations in your report.

- 10 sentences, no more.
- at least one figure containing a plot.
- no more than three figures. Figures may have multiple plots in them (i.e. panel plots), but there cannot be more than three figures total.

# Data Processing

which describes (in words and code) how the data were loaded into R and processed for analysis. In particular, your analysis must start from the raw CSV file containing the data. You cannot do any preprocessing outside the document. If preprocessing is time-consuming you may consider using the cache = TRUE option for certain code chunks.

First we load software libraries and display the processing software environment.

```{r software_env, echo = TRUE}
library(dplyr)
library(ggplot2)
sessionInfo()
```

Next we load the data.

```{r load_data, echo = TRUE, cache = TRUE}
datapath <- 
    paste("/home/tim/datasciencecoursera/Practicing-R/Reproducible Research/PeerAssessment2/repdata_data_StormData.csv.bz2")
storm0 <- read.csv(datapath)
```

After importing the data, we display details about the data frame, including the first few rows and columns. There are `r format(dim(storm0)[1], big.mark = ",")` rows and `r dim(storm0)[2]` columns in this dataset. The variable headers are already descriptive, so I don't modify them.

```{r display_data, echo = TRUE}
dim(storm0)
head(storm0[, 1:10])
```

Preprocessing for the first question, which seeks to rank storm events by harmfulness to health. The question is not limited by timeframe or location. We only need variables for types of events and health outcomes, which we interpret to mean INJURIES and FATALITIES. We also check for missing values in the selected dataset, coded as NA (there are none).

```{r preprocess_question1, echo = TRUE}
storm1 <- 
    storm0 %>% 
    group_by(EVTYPE) %>% 
    select(EVTYPE, FATALITIES, INJURIES, REMARKS, REFNUM) %>%
    mutate(Harm.total = FATALITIES + INJURIES)

mean(is.na(storm1))

storm1.summary <- 
    storm1 %>% 
    summarise(Fatality.sum = sum(FATALITIES), 
              Fatality.mean = round(mean(FATALITIES), 5), 
              Fatality.median = median(FATALITIES),
              Injury.sum = sum(INJURIES), 
              Injury.mean = round(mean(INJURIES), 5),
              Injury.median = median(INJURIES)) %>% 
    filter(Fatality.sum > 0 | Injury.sum > 0)

summary(storm1.summary[ , 1:3])  # what am i doing here?

# this creates two separate top ten lists for fatalities and injuries, then jams them together.
# mean is probably better than sum...
top.fatal.sum <- top_n(storm1.summary, 5, Fatality.sum)
top.fatal.median <- top_n(storm1.summary, 5, Fatality.median)
top.injury.sum <- top_n(storm1.summary, 5, Injury.sum)
top.injury.median <- top_n(storm1.summary, 5, Injury.median)
top.harmful <- unique(rbind(top.fatal.sum, top.fatal.median, top.injury.sum, top.injury.median))

```

Preprocessing for the second question, which seeks to rank storm events by economic consquences. This question is also not limited by timeframe or location. We only need variables for types of events and economic outcomes, which is coded as 'damage' values representing dollar amounts for property and for crops. 

Both damage variables are accompanied by DMGEXP factor variables that define the value magnitude: K for thousands of dollars, M for millions, B for billions. I normalize this with the mutate() function in the first pipeline, which sets all damage values to thousands of dollars.

We also check for missing values in the selected dataset, coded as NA (there are none).

```{r preprocess_question2, echo = TRUE}
storm2 <- 
    storm0 %>% 
    group_by(EVTYPE) %>% 
    select(EVTYPE, PROPDMG, PROPDMGEXP, CROPDMG, CROPDMGEXP, REMARKS, REFNUM) %>%
    mutate( 
       PROPDMG = ifelse(PROPDMGEXP == "K", 
                        PROPDMG, 
                        ifelse(PROPDMG == "M", 
                               PROPDMG * 1000, 
                               PROPDMG * 1000000)),
       CROPDMG = ifelse(CROPDMGEXP == "K",
                        CROPDMG,
                        ifelse(CROPDMG == "M",
                               CROPDMG * 1000,
                               CROPDMG * 1000000))
       )

mean(is.na(storm2))

storm2.summary <- 
    storm2 %>%
    summarise(Propdmg.sum = sum(PROPDMG), 
              Propdmg.mean = round(mean(PROPDMG), 2), 
              Propdmg.median = median(PROPDMG),
              Cropdmg.sum = sum(CROPDMG), 
              Cropdmg.mean = round(mean(CROPDMG), 2),
              Cropdmg.median = median(CROPDMG)) %>%
    filter(Propdmg.sum > 0 | Cropdmg.sum > 0)

top.prop.sum <- top_n(storm2.summary, 5, Propdmg.sum)
top.prop.median <- top_n(storm2.summary, 5, Propdmg.median)
top.crop.sum <- top_n(storm2.summary, 5, Cropdmg.sum)
top.crop.median <- top_n(storm2.summary, 5, Cropdmg.median)
top.dmg <- unique(rbind(top.prop.sum, top.prop.median, top.crop.sum, top.crop.median))


```

# Results
1. Across the United States, which types of events (as indicated in the EVTYPE variable) are most harmful with respect to population health?

```{r plot1, echo = TRUE}


```

2. Across the United States, which types of events have the greatest economic consequences?

```{r plot1, echo = TRUE}

```



```{r, echo = TRUE}

```

